WITH bib_list AS (SELECT
rm.id AS bib_record_id,
'indiginous' AS category
FROM
sierra_view.record_metadata rm
JOIN
sierra_view.phrase_entry i
ON
rm.record_type_code = 'b' AND rm.id = i.record_id AND i.index_tag = 'i' AND SUBSTRING(i.index_entry FROM '[0-9]+') IN (
'9780062869944',
'9780141305714',
'9780735266100',
'9780061123153',
'9780063064164',
'9781250247759',
'9781772601664',
'9781772601176',
'9781772600858',
'9780060577902',
'9780140385045',
'9780545840750',
'9780938317777',
'9781646140411',
'9780689839603',
'9780141301693',
'9781770866157',
'9780064410298',
'9781773212968',
'9781442481411',
'9781534460683',
'9780735266131',
'9780062990402',
'9781419712203',
'9780375861949',
'9781937054533',
'9781927583944',
'9780062871992',
'9781419707858',
'9781620148396',
'9780060295318',
'9781933390536',
'9780395069622',
'9780060594961',
'9780063015371',
'9781772033175',
'9780062884312',
'9780060219437',
'9780062884329',
'9781683371359',
'9781683371342',
'9781602232952',
'9780060577933',
'9781496587145',
'9781477816295',
'9781683371397',
'9781683371380',
'9780061708787',
'9780061123214',
'9781984815378',
'9780060297879',
'9781524767334',
'9781368024662',
'9780688173975',
'9781478870258',
'9780060580926',
'9780593326213',
'9781250062895',
'9780062872043',
'9780888996596',
'9780395338902',
'9781553798347',
'9781553798521',
'9781553798439',
'9781553798491',
'9781553798378',
'9780547406329',
'9780062869975',
'9780064408882',
'9781620148235',
'9780142422984',
'9780735228863',
'9780544439177',
'9780060233341',
'9781581960228',
'9781623174866',
'9781937054519',
'9780060580896',
'9781629726083'
'9781534478541',
'9781683428954',
'9781499426755',
'9781608189014',
'9781635170764',
'9781624693182',
'9781608189021',
'9781510523401',
'9781640262232',
'9781624693144',
'9781640262249',
'9781624693106',
'9781553798590',
'9781553799016',
'9781250143631',
'9781554554072',
'9781553797760',
'9781640262256',
'9781532190834',
'9781534188952',
'9781538211496',
'9781640262263',
'9781608189038',
'9781510523425',
'9781338681604',
'9781538324646',
'9781508162919',
'9781502634481',
'9781538345429',
'9781608189045',
'9781510523449',
'9781512486445',
'9781608189052',
'9781482457902',
'9781937786878',
'9781508162902',
'9781459812345',
'9781510523487',
'9781534186781',
'9781646140152',
'9781773064550',
'9780889956063',
'9781728404592',
'9781624693120',
'9781640262270',
'9781927083529',
'9781640262287',
'9781608189069',
'9781553797395',
'9780778752424',
'9781534442702',
'9781508162872',
'9781532111709',
'9781532111716',
'9781532111723',
'9781532111730',
'9781532111747',
'9781532111754',
'9781532111761',
'9781532111778',
'9781773214962',
'9781939053282',
'9780399542657',
'9781074524746',
'9781723305689',
'9781624692918'
)
UNION
SELECT
rm.id AS bib_record_id,
'latinx' AS category
FROM
sierra_view.record_metadata rm
JOIN
sierra_view.phrase_entry i
ON
rm.record_type_code = 'b' AND rm.id = i.record_id AND i.index_tag = 'i' AND SUBSTRING(i.index_entry FROM '[0-9]+') IN (
'9781940953892',
'9781916465664',
'9780062872364',
'9781566895255',
'9781643750255',
'9781941088678',
'9781945492150',
'9780816537372',
'9780525573128',
'9781558859128',
'9781947534797',
'9781542019774',
'9781420150193',
'9780385545891',
'9780811227384',
'9780374257866',
'9780811229265',
'9781558858565',
'9780811226714',
'9781609809584',
'9781946724229',
'9780811219099',
'9780374118013',
'9780593086865',
'9781885983572',
'9781250185815',
'9781947993877',
'9781644450697',
'9781594489587',
'9781644450413',
'9781948226882',
'9780811215473',
'9780525521693',
'9781948830164',
'9781250785589',
'9780811228718',
'9781542090353',
'9781951709204',
'9780806160726',
'9781948830256',
'9781936932825',
'9780871404961',
'9781566895156',
'9780735222885',
'9781940885490',
'9781913394431',
'9781501198748',
'9781944700874',
'9780593134078',
'9781641291309',
'9780063021747',
'9781943156269',
'9781916277847',
'9781641290197',
'9780312427252',
'9781632060471',
'9781542022781',
'9781939810601',
'9781250765864',
'9781609452520',
'9781542003735',
'9780811230933',
'9781250205933',
'9780802128157',
'9781948830058',
'9781573226066',
'9780062987730',
'9780872868335',
'9781999368432',
'9781646050611',
'9781566894944',
'9781566895460',
'9781477317778',
'9780811216302',
'9781542046367',
'9781644450253',
'9781999368463',
'9781941026717',
'9781936932757'
'9780778311164',
'9781999859305',
'9780393242836',
'9781913394387',
'9780872867727',
'9780374158231',
'9781912242191',
'9780228008606',
'9780385542722',
'9781951971038',
'9780525620778',
'9781912242177',
'9781609453657',
'9780593188644',
'9781949641059',
'9780374601232',
'9781933354385',
'9781632061508',
'9781940953670',
'9781619029590',
'9781635420722',
'9780316154895',
'9780062676979',
'9781501117015',
'9780811228213',
'9781565129757',
'9781951142308',
'9781948226240',
'9780316154529',
'9780811230735',
'9781911508489',
'9780062990747',
'9781558614352',
'9781565129764',
'9781945492303',
'9781982159467',
'9781982102548',
'9780316025263',
'9781420150179',
'9781984855831',
'9780062936868',
'9780525534624',
'9780816535620',
'9781908276926',
'9781250802569',
'9781662600302',
'9780451490889',
'9781948830324',
'9780814255896',
'9780374239947',
'9781617757181',
'9780811219082',
'9781635901405',
'9781609454302',
'9781916465640',
'9781335010124',
'9780525436461',
'9780060594817',
'9781631528804',
'9780062959966',
'9781936932252',
'9781594634277',
'9781101982266',
'9781328589347',
'9780811227322',
'9781911508601',
'9780593313664',
'9781941920831',
'9780525620785',
'9780374211899',
'9781951631017',
'9780802157676',
'9781942658443',
'9780399184628',
'9781542040495',
'9780374216535',
'9781944211776',
'9781936932436',
'9780374216306',
'9780374155124',
'9781644450550',
'9781982120726',
'9780399586682',
'9780393352214',
'9780374222789',
'9781916277878',
'9781250776686',
'9781948226165',
'9781566895804',
'9781916465626',
'9781947627338',
'9781916277861',
'9781250204882',
'9781597091145',
'9780143135036',
'9780593318416',
'9781943156849',
'9781631525414',
'9780872867710',
'9780316154871',
'9781641290159',
'9781787586031',
'9781496728623',
'9781566895965',
'9781646050192',
'9781566895507',
'9781951709464',
'9780735216860',
'9781982604615',
'9781609454258',
'9781612196619',
'9781642472349',
'9780143135623',
'9780525511304',
'9780312427481',
'9781939810342',
'9781936787869',
'9780735211155',
'9781609455897',
'9781620540206',
'9781911508823',
'9781999722708',
'9780593190135',
'9781594632747',
'9781644450079',
'9780814257982',
'9780735222854',
'9781940953977',
'9781496728593',
'9780312420284',
'9781504066426',
'9780358006084',
'9781597098922',
'9780062994172',
'9780374223779',
'9780997366679',
'9780062974846',
'9781631497735',
'9781984897480',
'9780374538330',
'9781911508342',
'9781542003742',
'9781594487361',
'9781913505240',
'9781945492501',
'9781617755392',
'9780374277956',
'9781916465619',
'9780735224797',
'9781644450475',
'9781542016698',
'9781780748924',
'9780452273870',
'9781947993921',
'9781566896108',
'9780593356821',
'9780060594800',
'9781328639073',
'9780451490865',
'9781477317747',
'9781635577334',
'9781681373232',
'9781948908696',
'9781616209490',
'9780062959928'

)
)

SELECT
SUBSTRING(i.location_code FROM 1 FOR 3) AS location,
bl.category,
ROUND(100.0 * CAST(COUNT(DISTINCT bl.bib_record_id) AS NUMERIC (12,2)) / (SELECT CAST(COUNT(bib_record_id) AS NUMERIC (12,2)) FROM bib_list),2)

FROM
sierra_view.bib_record_item_record_link l
JOIN
bib_list bl
ON
l.bib_record_id = bl.bib_record_id
JOIN
sierra_view.item_record i
ON
l.item_record_id = i.id

GROUP BY 1,2