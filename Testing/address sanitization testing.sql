SELECT
p.addr1,
p.addr2,
p.addr3,
p.city,
p.region,
p.postal_code,
--need to address 1st case of city_mod
COALESCE(CASE 
  WHEN p.city IS NOT NULL THEN REGEXP_REPLACE(TRIM(p.city),'\s[a-zA-Z]{2}\s?(\d{5,})?\s?\-?\s?(\d{4,})?$','')
  WHEN p.city IS NULL AND p.addr1 ~ '\y([A-Za-z]+),?\s[A-Za-z]{2}(?:\s?\d{5,})?$' THEN (REGEXP_MATCH(TRIM(p.addr1), '\y([A-Za-z]+),?\s[A-Za-z]{2}(?:\s?\d{5,})?$'))[1]
  --(REGEXP_MATCHES(p.city, ',\s*([^,]+),\s*[A-Z]{2}\s+\d{5}'))[1]
END,'') AS city_mod,
COALESCE(CASE WHEN p.region = '' AND (LOWER(p.city) ~ '\sma$' OR pr.pcode3 BETWEEN '1' AND '200') THEN 'MA'
  WHEN p.region IS NULL AND p.city IS NULL AND TRIM(p.addr1) ~ '^.*\s(ma|Ma|mA|MA)(\s\d{5,})|$' THEN 'MA' 
  ELSE REGEXP_REPLACE(p.region,'\d|\-|\s','','g') END,'') AS region_mod,
COALESCE(CASE WHEN p.postal_code IS NULL AND TRIM(p.region) ~ '(MA)?\s?\d{5}' THEN SUBSTRING(TRIM(p.region),'\d{5,9}\s?\-?\s?\d{0,4}')
  WHEN p.postal_code IS NULL AND p.region = '' AND p.city ~ '(MA)?\s?\d{5}' THEN SUBSTRING(TRIM(p.city),'\d{5,9}\s?\-?\s?\d{0,4}$')
  WHEN p.postal_code IS NULL AND p.region IS NULL AND p.city IS NULL AND p.addr1 ~ '(MA)?\s?\d{5}' THEN SUBSTRING(TRIM(p.addr1),'\d{5,9}\s?\-?\s?\d{0,4}$')
  ELSE SUBSTRING(p.postal_code,'^\d{5}') END,'') AS postal_code_mod

FROM
sierra_view.patron_record_address p
JOIN sierra_view.patron_record pr 
ON p.patron_record_id = pr.id

WHERE p.patron_record_address_type_id = '1'
AND p.patron_record_id IN (
'481038268018',
'481037370850',
'481037374915',
'481037538260',
'481037550817',
'481037565129',
'481037608743',
'481037683457',
'481037892709',
'481037929863',
'481038013788',
'481038370181',
'481038440393',
'481038537598',
'481038680315',
'481038735166',
'481038808938',
'481038809593',
'481038837357',
'481038933256',
'481038964409',
'481038976149',
'481038987483',
'481039003129',
'481039032045',
'481039047848',
'481039051521',
'481039081737',
'481039119970',
'481039139506',
'481039162558',
'481039173614',
'481039193279',
'481039211521',
'481039213342',
'481039216457',
'481039217508',
'481039222072',
'481039228705',
'481039231301',
'481039245246',
'481039249636',
'481039257557',
'481039261849',
'481039266160',
'481039266577',
'481039276124',
'481039280983',
'481039281719',
'481039290042',
'481039296819',
'481039318778',
'481039337688',
'481039351156',
'481039351597',
'481039352926',
'481039354331',
'481039403566',
'481039497038',
'481039538737',
'481039555508',
'481039556621',
'481039557910',
'481039562884',
'481039571340',
'481039608035',
'481039608035',
'481039608245',
'481039608552',
'481039608615',
'481039608637',
'481039608715',
'481039609019',
'481039609189',
'481039609195',
'481039609288',
'481039609362',
'481039609386',
'481039609483',
'481039609605',
'481039609651',
'481039609828',
'481039609830',
'481039609833',
'481039609835',
'481039609836',
'481039609838',
'481039609839',
'481039609852',
'481039609946',
'481039610067',
'481039610100',
'481039610101',
'481039610104',
'481039610107',
'481039610109',
'481039610110',
'481039610112',
'481039610113',
'481039610114',
'481039610115',
'481039610122',
'481039610123',
'481039610124',
'481039610125',
'481039610127',
'481039610128',
'481039610131',
'481039610132',
'481039610134',
'481039610135',
'481039610136',
'481039610137',
'481039610243',
'481039610267',
'481039610718',
'481039610718',
'481039610757',
'481039610942',
'481039610942',
'481039610990',
'481039611150',
'481039611185'
)